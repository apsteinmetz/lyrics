---
title: "What Do the Ramones Want?"
output: html_notebook
---
Recently I saw a tweet that shared this hilarious poster.
![](img/Wants4thEdition.jpg)

Dan Gneiding (aka Grayhood) is the graphic designer who created this.  You can buy it [here](http://grayhood.com/shop/ramones-vs-misfits-1-2-3-4th-edition)

Very cool, but how accurate is it?  I asked Dan and says he took some artistic license, as he should! You may accuse me of being that pedantic "Comic Book Guy" from "The Simpsons" but, when I saw it, I immediately wondered how I could tally these Ramones lyrics myself or, rather, get R to do it for me. The `tidytext` mining package makes short work of the project, as we'll see.

<iframe src="https://giphy.com/embed/26tk0Emxz61hdKEog" width="480" height="360" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/season-13-the-simpsons-13x8-26tk0Emxz61hdKEog">via GIPHY</a></p>

The Ramones hold a special place in my heart. As a college student in central Ohio, in the late 70s, my frat brothers and I were huge fans.  We were completely ridiculous of course. Preppy nerds bobbing to "Beat on the Brat"  The Sigma Chis thought we were idiots (Lynrd Skynrd? Come on! History has judged). I never saw the Ramones at CBGBs but when we heard they were coming to a cowboy bar on notorious High St. across from Ohio State, we were thrilled.  I blew off studying for a Poly-Sci mid-term the next day.  I got my worst college grade ever but it was totally worth it. I said my future self would thank me and I was right!

Without any further adieu, hey, ho, let's go!


```{r message=FALSE, warning=FALSE}
#devtools::install_github("dmi3kno/polite")
library(tidyverse)
library(tidytext)
library(rvest)
library(polite)
library(reshape2)
library(wordcloud)
library(scales)
library(ggthemes)

# very dark theme for ggplot courtesy of
#https://gist.github.com/jslefche/eff85ef06b4705e6efbc
source("ggplot_theme_black.r")

```
There are many lyric sites on the web I chose [](azlyrics.com) because the simple layout of the site made it easy to scrape.  We want to be good netizens, of course.  A new package (still in development as of this writing). `polite` makes it trivially easy to respect restrictions on site scraping found in the `robots.txt` file found at most commercial sites by using the functions `polite::bow() %>% polite::scrape() %>% rvest::html_nodes()`.  My previous work has not done this so I am happy to see this package arrive.  I think it needs a `grovel()` function though.

As usual when I do my notebooks iteratively, I save scraped data and don't go out to the web if I have previously retrieved it.  Check for it first.

First, we retrieve the urls for each song from the band page.
```{r}
if (file.exists("data/ramones_song_list.rdata")){
  load("data/ramones_song_list.rdata")
} else {
# be polite. get scraping parameters.
base_url <- "https://azlyrics.com"
 song_list_raw <- polite::bow("https://azlyrics.com/r/ramones.html") %>% 
   polite::scrape() %>%
   rvest::html_nodes("#listAlbum a")

song_list <- song_list_raw %>% 
  rvest::html_attr("href") %>% 
  tibble::enframe(name = NULL,value = "lyric_url") %>% 
  dplyr::mutate(song_name = html_text(song_list_raw)) %>% 
  mutate(lyric_url=str_replace(lyric_url,"..",base_url))
save(song_list,file="data/ramones_song_list.rdata")
}

song_list
```

Now get all the lyrics.  I wrote a function that returns a single string with the a single song's lyrics.  To get all the songs I used a `for` loop to go the the list of lyric URLs. Why did I do this rather than using the fancier `apply` or `map`?  Because the risk of failure is high.  Depsite using `polite` I got locked out of the site after many songs and had to wait some time before trying again.  Had we used `map` the accumulated lyrics retrieved prior to getting shut out would be lost.  This way we can just manually set the index of the URL list to pick up at the point we got shut out.
```{r}
#make a function to get lyrics

get_lyric <- function(lyric_url){
  lyric <- bow(lyric_url) %>% 
    scrape() %>% 
    #    /html/body/div[4]/div/div[2]/div[5]
    # body > div.container.main-page > div > div.col-xs-12.col-lg-8.text-center > div:nth-child(8)
    html_nodes("div") %>%
    #not happy with this.  relies on the lyrics always being the 22nd `<div>` tag on the page.
    .[22] %>% 
    html_text() %>%
    str_remove_all("\r") %>% 
    str_replace_all("\n"," ") %>% 
    str_trim()
  return(lyric)
}

if (file.exists("data/raw_ramones_lyrics.rdata")){
  load("data/raw_ramones_lyrics.rdata")
} else {
  all_lyrics <- NULL
  all_urls <- song_list$lyric_url
  for (lyric_url in all_urls){
    lyric <- get_lyric(lyric_url)
    all_lyrics <- c(all_lyrics,lyric)
    
  }
  save(all_lyrics,file="data/raw_ramones_lyrics.rdata")
}

print(all_lyrics[1])
```

Make the list of lyric strings into a complete data frame with all the trimmings.
```{r}
ramones_lyrics <- song_list %>%  
  bind_cols(enframe(all_lyrics,name="corpus_order",value="lyrics")) %>% 
  mutate(band="Ramones") %>% 
  select(band,song_name,lyrics,corpus_order,lyric_url) %>% 
  {.}

ramones_lyrics
```

Most projects require a huge amount of data wrangling before we can get any real analysis done.  This project is pretty clean.  We are already nearly good to go.  Further, `tidytext` makes the remaining manipulation of the data soooo easy!  To wit, let's tokenize the data into individual words.
```{r}
lyric_words <- ramones_lyrics %>% select(-band,-lyric_url) %>% unnest_tokens(word,lyrics)

```
That's it!  Before we look at the what the Ramones want we might as well run the, now routine, sentiment analysis we all learned about [here](https://cran.r-project.org/web/packages/tidytext/vignettes/tidytext.html).  The Ramones are no Jane Austen but, hey, they have feelings, ya know?

To start our sentiment analysis let's pull out stop words that don't provide much context.
```{r}
lyric_words_cleaned <- lyric_words %>% anti_join(get_stopwords(),by="word")

#quick sentiment analysis
positive <- get_sentiments("bing") %>%
  filter(sentiment == "positive")

negative <- get_sentiments("bing") %>%
  filter(sentiment == "negative")

lyric_words_cleaned %>%
  semi_join(positive,by="word") %>%
  group_by(song_name) %>% 
  count(word) %>% 
  group_by(song_name) %>% 
  tally(sort = TRUE,name="Happy Words")
  
```

```{r}
lyric_words_cleaned %>%
  semi_join(negative,by="word") %>%
  group_by(song_name) %>% 
  count(word) %>% 
  group_by(song_name) %>% 
  tally(sort = TRUE,name="Sad Words")
  

```

```{r}
lyric_words_cleaned %>%
  inner_join(get_sentiments("bing"),by="word") %>%
  group_by(song_name) %>% 
  count(sentiment,sort=TRUE) %>% 
  mutate(n = ifelse(sentiment == "negative", -n, n)) %>%
  group_by(song_name) %>% 
  summarise(net_sentiment=sum(n)) %>% 
  filter(abs(net_sentiment) > 10) %>%
  mutate(song_name = reorder(song_name, net_sentiment)) %>%
  mutate(sentiment=ifelse(net_sentiment<0,"Negative","Positive")) %>% 
  ggplot(aes(song_name, net_sentiment, fill = sentiment)) +
  geom_col() +
  coord_flip() +
  labs(title="How Happy are RAMONES Songs?",
       y = "Balance of Postive to Negative Words",
       x= "") +
    theme_black() +
  scale_fill_manual(values = c("red","darkgrey"))+
  theme(axis.text.y =  element_text(size=7,hjust=1)) 
```

What is overall sentiment?
"Sentiment" is a funny thing.  We can guess at the sentiment of words without context but we can't be sure.  Certainly "punk" is not a negative word in the world of the Ramones so we should probably filter that out.
```{r}
lyric_words_cleaned %>%
  filter(word != "punk") %>% 
  inner_join(get_sentiments("bing"),by="word") %>%
  count(sentiment,sort=TRUE) %>% 
  ggplot(aes(sentiment, n, fill = sentiment)) +
  geom_col() +
  labs(title="How Happy are the RAMONES?",
       y = "Word Count (excluding 'Punk')",
       x= "") +
    theme_black() +
  scale_fill_manual(values = c("red","darkgrey"))+
  theme(axis.text.y =  element_text(size=7,hjust=1)) 

```
```{r}
{par(bg="black")
lyric_words_cleaned %>%
  inner_join(get_sentiments("bing"),by="word") %>%
  count(word, sentiment, sort = TRUE) %>%
  acast(word ~ sentiment, value.var = "n", fill = 0) %>%
#  comparison.cloud(colors = c("#F8766D", "#00BFC4"),
#                   max.words = 100)
  comparison.cloud(colors = c("red", "grey60"),
                   max.words = 100,
                   title.bg.colors="grey60")
}
```

Now lets find what the Ramones Want.  An n-gram is simply a cluster of words of length n.  Let's look at the most common n-grams, which would include the phrases like "I want" and "I wanna."

Start with shortest n-gram that is a complete thought and work up to longer phrases.  We take the the shortest phrase that makes sense unless appending more words doesn't change the frequency.  Then we take the longer phrase.  For instance if "I wanna steal some money" and "I wanna steal from the rich" both exist we take "I wanna steal" since it would have a higher frequency than either longer phrase.  In this case, the only phrase starting with "I wanna steal"  is "I wanna steal from the rich" so we use that.
```{r}
want_phrases <- "^(i wanna |i want |we want |we wanna |i wanted |i just want |i just wanna )"

get_ngrams <- function(lyrics,n,prefixes=""){
  min_instance = 0
  lyric_ngram <- lyrics %>% 
    select(-band,-lyric_url) %>% 
    unnest_tokens(ngram,lyrics,token = "ngrams",n=n) %>% 
    group_by(ngram) %>% 
    filter(str_detect(ngram,prefixes)) %>% 
    count() %>% 
    arrange(desc(n)) %>% 
    filter(n>min_instance) %>% mutate(want=str_remove(ngram,prefixes)) %>% 
    rownames_to_column()
  return(lyric_ngram)
  
}

want <- ramones_lyrics %>% get_ngrams(3,want_phrases)
want
```

What a human needs to do is decide which phrases are complete thoughts.  We manually select the row numbers to build our ultimate table and build a longer n-gram table to flesh out those that are not.

Remember what I said before about data wrangling?  Well, getting the words was easy.  Determining meaningful phrases is not.  If this was Spotify, our AI could figure these out, but it is not Spotify. This is a manual,iterative process of taking ever-longer n-grams until we don't see any sensible new phrases.  I won't bore you with every iteration so let's skip ahead.

```{r}
# make "wanna" in to "want to" which also frequently appears so we get a good count.
ramones_lyrics <- ramones_lyrics %>% mutate(lyrics=str_replace_all(lyrics,"wanna","want to"))
want_phrases <- "^(i wanna |i want |we want |we wanna |i wanted |i just want |i just wanna )"
do_want <- tibble()
all_wants <- tibble() # for debugging
# why make the code below a function, if we only call it once?
# Since we cumulatively modify all_wants each step is dependent on the prior one executing first
# this organizes the code into a block that tells future self to execute as a block
build_wants <- function(all_wants) {
  #select the 3-gram phrases that are complete thoughts using manual inspection
  want <- ramones_lyrics %>% get_ngrams(3,want_phrases)
  all_wants <- bind_rows(all_wants,want[c(2,3,11),])
  # move to the 4-gram phrases, etc
  want <- ramones_lyrics %>% get_ngrams(4,want_phrases)
  all_wants <- bind_rows(all_wants,want[c(5,17,18,23,4,26,27,31,44,40),])
  want <- ramones_lyrics %>% get_ngrams(5,want_phrases)
  #want
  all_wants <- bind_rows(all_wants,want[c(1,2,6,8,26,28,41),])
  want <- ramones_lyrics %>% get_ngrams(6,want_phrases)
  #want
  all_wants <- bind_rows(all_wants,want[c(14,36,43,53),])
  want <- ramones_lyrics %>% get_ngrams(7,want_phrases)
  #want
  all_wants <- bind_rows(all_wants,want[c(5,9,14,15,27,28,51),])
  want <- ramones_lyrics %>% get_ngrams(8,want_phrases)
  #want
  all_wants <- bind_rows(all_wants,want[c(14,22),])
  return (all_wants)
}

do_want <- build_wants(do_want)
do_want <- do_want %>% arrange(desc(n))
do_want
```
Clean up the text and tally the instances of each want.
```{r}
do_want_clean <- do_want %>% 
#  mutate(want = str_remove(want,"^to |ed |wanna |^was to |^is |^be with ")) %>% 
  mutate(want=str_to_title(want)) %>% 
  group_by(want) %>%
  summarise(n=sum(n)) %>% 
  arrange(desc(n))
do_want_clean
```

```{r}
do_want_clean %>% mutate(want=reorder(want,n)) %>% 
  ggplot(aes(want,n)) + geom_col()+coord_flip() +
  theme_black() +
  theme(axis.text.y = element_text(hjust=1,size=10))+ 
  scale_fill_manual(values = c("red","darkgrey"))

```
What DON'T the Ramones want? Once again, we go through the same iterative process with different phrase stems.
```{r}
dont_want <- tibble()
all_wants <- tibble() # for debugging only
ramones_lyrics <- ramones_lyrics %>% mutate(lyrics=str_replace_all(lyrics,"wanna","want to"))
want_phrases <- "^(i don't want |we don't want |i didn't want )"
build_dont_wants <- function(all_wants) {
  want <- ramones_lyrics %>% get_ngrams(4,want_phrases) %>% mutate(n = -n)
  all_wants <- bind_rows(all_wants,want[c(2),])
#  want
  want <- ramones_lyrics %>% get_ngrams(5,want_phrases) %>% mutate(n = -n)
  #want
  all_wants <- bind_rows(all_wants,want[c(4,5,6,10,12),])
  want <- ramones_lyrics %>% get_ngrams(6,want_phrases) %>% mutate(n = -n)
  #want
  all_wants <- bind_rows(all_wants,want[c(1),])
  want <- ramones_lyrics %>% get_ngrams(7,want_phrases) %>% mutate(n = -n)
#  want
  all_wants <- bind_rows(all_wants,want[c(2,30,31,33),])
  want <- ramones_lyrics %>% get_ngrams(8,want_phrases) %>% mutate(n = -n)
#  want
  all_wants <- bind_rows(all_wants,want[c(13,14,18,29,34),])
  want <- ramones_lyrics %>% get_ngrams(9,want_phrases) %>% mutate(n = -n)
#  want
  all_wants <- bind_rows(all_wants,want[8,])
  want <- ramones_lyrics %>% get_ngrams(10,want_phrases) %>% mutate(n = -n)
#  want
  #there it is - Pet Sematary!
  all_wants <- bind_rows(all_wants,want[c(2),])
}
dont_want <- build_dont_wants(dont_want)
dont_want <- dont_want %>% arrange(n) %>% select(-rowname)
dont_want_clean <- dont_want %>% 
#  mutate(want = str_remove(want,"^to |ed |wanna |^was to |^is |^be with ")) %>% 
  mutate(want=str_to_title(want)) %>% 
  group_by(want) %>%
  summarise(n=sum(n)) %>% 
  arrange(n)
dont_want_clean
```


```{r}
ultimate_want <- bind_rows(do_want_clean,dont_want_clean) %>% 
  group_by(want) %>%
  summarise(n=sum(n)) %>%   
  mutate(sentiment = ifelse(n > 0,"want","don't want")) %>% 
  arrange(n) %>% 
#  mutate(want=str_to_title(want)) %>% 
  {.}
ultimate_want
```

```{r}
p <- ultimate_want %>% mutate(want=reorder(want,n)) %>% 
  ggplot(aes(want,n,fill=sentiment)) + geom_col()+coord_flip()+
  labs(title="What Do The RAMONES Want?",
       y="How Much Do The RAMONES Want It?",
       x="") + theme_black()
p + 
  scale_fill_manual(values = c("red","darkgrey"))+
  theme(axis.text.y =  element_text(size=7,hjust=1)) 
```

Sometimes, late at night, after everyone else is asleep, I hide under the covers, open my laptop and look at... pie charts. Ed Tufte says I will go blind if I keep doing it.  Still, for the sake of bringing this full circle let's make a version of Grayhood's poster with our data.  So it's not a complete mess we lump any phrases that occur less than 4 times in "Other."  That takes some of the fun out of things since we lose memorable phrases like "I wanna sniff some glue" which the poster above includes.  This is data science, not art.  It's not supposed to be fun! While I use ggplot2 pretty much exclusively, the base R `pie` plot produces pretty clean results that approximate the style of the poster with no embellishment. 

```{r}
collapsed_want <- ultimate_want %>%
  filter(sentiment=="want") %>%
  mutate(want = ifelse(n<3,"Other",want)) %>%
  group_by(want) %>% 
  summarise(n=sum(n)) %>% 
  arrange(desc(n)) %>% 
  {.}

 with(collapsed_want,
      pie(n, 
          labels=paste0(as.character(want), " ", n, "%"),
          col=c("brown","red","black","darkblue","pink","purple"),
          radius=1,
          density=30,
          bg="sienna",
          main="The Ramones Want..."))
```

```{r}
collapsed_want <- ultimate_want %>%
  filter(sentiment=="don't want") %>%
  mutate(n = -n) %>% 
  mutate(want = ifelse(n<2,"Other",want)) %>%
  group_by(want) %>% 
  summarise(n=sum(n)) %>% 
  arrange(desc(n)) %>% 
  {.}

 with(collapsed_want,
      pie(n, 
          labels=paste0(as.character(want), " ", n, "%"),
          col=c("brown","red","black","darkblue","pink","purple"),
          radius=1,
          density=30,
          bg="sienna",
          main="The RAMONES Don't Want..."))
```


